# 3.2 Mô hình xử lý

## 3.2.1 Use case chi tiết

### 3.2.1.1 Quản lý tài khoản và xác thực

**Hình 3-3 Use-case quản lý tài khoản**

| Tên Use case | Quản lý Tài Khoản |
|--------------|-------------------|
| Actor | Người dùng (User), Quản trị viên (Admin) |
| Mô tả | Người dùng thực hiện các thao tác liên quan đến tài khoản như đăng nhập, đăng ký, đăng xuất thông qua dịch vụ Clerk Authentication Service. Hệ thống tự động đồng bộ dữ liệu user từ Clerk vào MongoDB qua Inngest webhooks. |
| Pre-conditions | Hệ thống phải kết nối được với Clerk Authentication Service. Hệ thống phải kết nối được với Inngest để nhận webhooks. |
| Post-conditions | **Success**: Thực hiện thành công chức năng được chọn, user được đồng bộ vào database. **Fail**: Hiển thị thông báo lỗi và quay lại màn hình trước đó. |
| Luồng sự kiện chính | Actor truy cập hệ thống. Hệ thống hiển thị giao diện chính. - Extend Use Case Đăng nhập - Extend Use Case Đăng ký - Extend Use Case Đăng xuất |
| Luồng sự kiện phụ | Actor nhấn nút Thoát. Hệ thống đóng màn hình hiện tại. |

#### <Extend Use Case> Đăng nhập

1. Actor chọn đăng nhập
2. Hệ thống chuyển hướng đến trang đăng nhập Clerk
3. Clerk hiển thị form đăng nhập với các tùy chọn: Email + Password, Google OAuth, Facebook OAuth
4. Người dùng chọn phương thức và nhập thông tin
5. Clerk xác thực thông tin đăng nhập
6. Clerk trả về JWT token cho frontend
7. Frontend lưu token vào session
8. Hệ thống kiểm tra user trong database MongoDB
9. Nếu user chưa tồn tại trong database (do webhook chưa kịp xử lý), hệ thống tạo mới user record từ thông tin Clerk
10. Hệ thống chuyển về trang chủ với trạng thái đã đăng nhập
11. Kết thúc

**Rẽ nhánh 1:**
- 5.1 Nếu thông tin đăng nhập không hợp lệ, Clerk hiển thị thông báo lỗi và quay lại bước 4

**Rẽ nhánh 2:**
- 6.1 Nếu không nhận được token, hiển thị thông báo "Đăng nhập thất bại" và kết thúc

**Rẽ nhánh 3:**
- 8.1 Nếu user chưa tồn tại và tạo user mới thất bại, hệ thống vẫn cho phép đăng nhập nhưng ghi log lỗi để xử lý sau

#### <Extend Use Case> Đăng ký

1. Người dùng chọn nút "Sign Up" hoặc "Đăng ký"
2. Hệ thống chuyển hướng đến trang đăng ký Clerk
3. Clerk hiển thị form đăng ký
4. Người dùng nhập thông tin:
   - Email
   - Password (tối thiểu 8 ký tự)
   - Xác nhận Password
   - Họ tên (First Name, Last Name)
5. Clerk kiểm tra tính hợp lệ của dữ liệu:
   - Email chưa được sử dụng
   - Password đủ mạnh
   - Password và xác nhận password khớp nhau
6. Clerk tạo tài khoản và gửi email xác thực
7. Người dùng mở email và click link xác thực
8. Clerk xác nhận email thành công
9. Clerk tự động trigger webhook event `clerk/user.created`
10. Inngest nhận webhook và trigger function `sync-user-from-clerk`
11. Function tạo user record trong MongoDB với thông tin từ Clerk:
    - _id: Clerk User ID
    - name: First Name + Last Name
    - email: Email address
    - image: Image URL
    - favoriteMovies: [] (mảng rỗng)
12. Hệ thống tự động đăng nhập người dùng và chuyển về trang chủ
13. Kết thúc

**Rẽ nhánh 1:**
- 5.1 Nếu email đã tồn tại, Clerk hiển thị "Email đã được sử dụng" và quay lại bước 4
- 5.2 Nếu password không đủ mạnh, Clerk hiển thị yêu cầu password và quay lại bước 4
- 5.3 Nếu password không khớp, hiển thị "Mật khẩu xác nhận không khớp" và quay lại bước 4

**Rẽ nhánh 2:**
- 7.1 Nếu người dùng không xác nhận email trong 24h, link xác thực hết hạn, yêu cầu gửi lại email

**Rẽ nhánh 3:**
- 10.1 Nếu webhook thất bại hoặc Inngest function lỗi, hệ thống retry tối đa 3 lần và ghi log để xử lý manual. User vẫn có thể đăng nhập nhưng chưa có record trong MongoDB.

#### <Extend Use Case> Đăng xuất

1. Người dùng đã đăng nhập chọn "Sign Out" hoặc "Đăng xuất"
2. Hệ thống xóa JWT token khỏi session
3. Clerk xóa authentication state
4. Hệ thống chuyển hướng về trang chủ với trạng thái chưa đăng nhập
5. Kết thúc

**Rẽ nhánh 1:**
- 2.1 Nếu xóa token thất bại, hệ thống vẫn chuyển về trang chủ và ghi log

---

### 3.2.1.2 Quản lý xem phim

**Hình 3-4 Use-case quản lý xem phim**

| Tên Use case | Quản lý Xem Phim |
|--------------|------------------|
| Actor | Người dùng (User) |
| Mô tả | Người dùng xem danh sách phim đang chiếu và sắp chiếu. Dữ liệu phim được lấy từ TMDB API và lưu trong database. Người dùng không cần đăng nhập để xem danh sách phim. |
| Pre-conditions | Hệ thống kết nối được với TMDB API. Database có dữ liệu phim hoặc có suất chiếu. |
| Post-conditions | **Success**: Lấy và hiển thị dữ liệu thành công. **Fail**: Hiển thị thông báo lỗi phù hợp. |
| Luồng sự kiện chính | Actor truy cập hệ thống. Hệ thống hiển thị danh sách phim. - Extend Use Case Xem danh sách phim |
| Luồng sự kiện phụ | Actor nhấn nút Thoát. Hệ thống quay về trang chủ. |

#### <Extend Use Case> Xem danh sách phim

1. Người dùng truy cập trang danh sách phim hoặc trang chủ
2. Hệ thống gửi yêu cầu lấy danh sách phim đang chiếu
3. Backend truy vấn database lấy tất cả các suất chiếu có `showDateTime >= hiện tại`
4. Backend lọc các suất chiếu thuộc phòng chiếu có `status = 'active'`
5. Backend tổng hợp để lấy các phim duy nhất (unique movies)
6. Backend populate thông tin chi tiết của từng phim từ database:
   - Nếu phim chưa có trong database, fetch từ TMDB API và lưu vào database
   - Bổ sung thông tin: title, overview, poster_path, backdrop_path, genres, casts, vote_average, runtime
7. Backend sắp xếp danh sách phim theo ngày phát hành mới nhất
8. Hệ thống trả về danh sách các phim
9. Frontend hiển thị danh sách phim dạng lưới (grid) với mỗi phim hiển thị:
   - Poster phim
   - Tên phim
   - Thể loại
   - Đánh giá (rating)
   - Nút "Xem chi tiết"
10. Kết thúc

**Rẽ nhánh 1:**
- 3.1 Nếu không có suất chiếu nào, hiển thị thông báo "Hiện chưa có phim nào đang chiếu" và kết thúc

**Rẽ nhánh 2:**
- 6.1 Nếu TMDB API lỗi, hệ thống hiển thị thông báo lỗi, retry tự động sau 3 giây (tối đa 3 lần)
- 6.2 Nếu retry vẫn thất bại, hiển thị thông báo "Không thể tải danh sách phim. Vui lòng thử lại sau."

---

### 3.2.1.3 Quản lý suất chiếu

**Hình 3-5 Use-case quản lý suất chiếu**

| Tên Use case | Quản lý Suất Chiếu |
|--------------|-------------------|
| Actor | Quản trị viên (Admin) |
| Mô tả | Admin: Thêm suất chiếu mới từ TMDB API, xem tất cả suất chiếu, hủy suất chiếu (nếu chưa có người đặt vé), đồng bộ thông tin phim từ TMDB. |
| Pre-conditions | Hệ thống kết nối được với TMDB API. Admin phải đăng nhập và có quyền admin (privateMetadata.role === 'admin'). Database có ít nhất một phòng chiếu (CinemaHall) với status = 'active'. |
| Post-conditions | **Success**: Dữ liệu được hiển thị/cập nhật/xóa chính xác. **Fail**: Hiển thị thông báo lỗi phù hợp. |
| Luồng sự kiện chính | Actor truy cập hệ thống. Hệ thống hiển thị giao diện quản lý suất chiếu. - Extend Use Case Thêm suất chiếu mới (Admin only) - Extend Use Case Xem danh sách suất chiếu - Extend Use Case Hủy suất chiếu (Admin only) |
| Luồng sự kiện phụ | Actor nhấn nút Thoát. Hệ thống quay về trang admin dashboard. |

#### <Extend Use Case> Thêm suất chiếu mới (Admin only)

1. Admin chọn menu "Thêm chương trình" hoặc "Add Shows"
2. Hệ thống hiển thị form thêm suất chiếu
3. Admin nhập thông tin:
   - Chọn phim từ danh sách (tìm kiếm từ TMDB hoặc chọn từ database)
   - Chọn phòng chiếu (CinemaHall)
   - Nhập giá vé cơ bản (VNĐ)
   - Chọn ngày chiếu
   - Chọn các giờ chiếu (có thể chọn nhiều giờ)
4. Hệ thống kiểm tra tính hợp lệ:
   - Phim phải tồn tại trong TMDB
   - Phòng chiếu phải có status = 'active' (không phải maintenance)
   - Giá vé > 0
   - Ngày chiếu >= ngày khởi chiếu của phim (release_date)
   - Không trùng lịch với suất chiếu khác trong cùng phòng
5. Hệ thống tính toán thời gian kết thúc cho mỗi suất chiếu:
   - endDateTime = showDateTime + runtime + 10 phút (buffer) + 20 phút (vệ sinh)
6. Hệ thống kiểm tra xung đột lịch chiếu:
   - Kiểm tra với các suất chiếu đã có trong database (cùng phòng, thời gian overlap)
   - Kiểm tra xung đột giữa các suất chiếu trong cùng lần thêm
7. Nếu có xung đột, hệ thống hiển thị danh sách xung đột và yêu cầu sửa lại
8. Nếu không có xung đột, hệ thống tạo các suất chiếu:
   - Nếu phim chưa có trong database, fetch từ TMDB và lưu vào database
   - Tạo các Show records với thông tin: movie, hall, showDateTime, endDateTime, showPrice, occupiedSeats = {}
9. Nếu đây là phim mới lần đầu được thêm, hệ thống trigger Inngest event `app/show.added`
10. Inngest gửi email thông báo phim mới cho tất cả users
11. Hệ thống hiển thị thông báo "Đã thêm X suất chiếu thành công"
12. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu phim không tồn tại trong TMDB, hiển thị "Không tìm thấy phim" và quay lại bước 3
- 4.2 Nếu phòng chiếu đang bảo trì, hiển thị "Phòng chiếu đang bảo trì" và quay lại bước 3
- 4.3 Nếu giá vé <= 0, hiển thị "Giá vé phải lớn hơn 0" và quay lại bước 3
- 4.4 Nếu ngày chiếu < ngày khởi chiếu phim, hiển thị "Không thể tạo suất chiếu trước ngày khởi chiếu" và quay lại bước 3

**Rẽ nhánh 2:**
- 7.1 Nếu có xung đột, hiển thị danh sách chi tiết các xung đột (ngày, giờ, phim xung đột) và yêu cầu admin sửa lại

**Rẽ nhánh 3:**
- 8.1 Nếu fetch phim từ TMDB thất bại, hiển thị "Không thể lấy thông tin phim từ TMDB" và quay lại bước 3
- 8.2 Nếu tạo Show records thất bại, rollback và hiển thị "Không thể tạo suất chiếu" và quay lại bước 3

#### <Extend Use Case> Xem danh sách suất chiếu

1. Admin chọn menu "Danh sách chương trình" hoặc "List Shows"
2. Hệ thống gửi yêu cầu lấy danh sách suất chiếu
3. Hệ thống xác thực quyền admin
4. Backend truy vấn database lấy tất cả suất chiếu có:
   - showDateTime >= hiện tại
   - hall tồn tại (không phải legacy data)
5. Backend populate thông tin: movie, hall
6. Backend sắp xếp theo showDateTime tăng dần
7. Backend tính toán cho mỗi suất chiếu:
   - Tổng số ghế đã đặt = số keys trong occupiedSeats
   - Thu nhập = số ghế đã đặt × showPrice
8. Hệ thống trả về danh sách suất chiếu
9. Frontend hiển thị bảng với các cột:
   - Tên phim
   - Phòng chiếu (tên, số phòng, loại)
   - Thời gian chiếu (ngày, giờ)
   - Tổng số lượng đặt chỗ
   - Thu nhập
   - Thao tác (nút Hủy)
10. Admin có thể lọc theo:
    - Phim
    - Phòng chiếu
11. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu không có suất chiếu nào, hiển thị "Không tìm thấy suất chiếu nào"

#### <Extend Use Case> Hủy suất chiếu

1. Admin đang ở trang "Danh sách chương trình"
2. Admin chọn suất chiếu cần hủy và nhấn nút "Hủy"
3. Hệ thống hiển thị hộp thoại xác nhận
4. Admin xác nhận hủy
5. Hệ thống gửi yêu cầu hủy suất chiếu
6. Backend xác thực quyền admin
7. Backend kiểm tra suất chiếu có tồn tại không
8. Backend kiểm tra số ghế đã đặt (occupiedSeats):
   - Đếm số keys trong occupiedSeats
9. Nếu có ghế đã đặt (occupiedSeats > 0):
   - Backend kiểm tra thêm các booking đã thanh toán (ispaid = true, status != 'cancelled')
   - Nếu có booking đã thanh toán, từ chối hủy
10. Nếu không có ghế đã đặt và không có booking đã thanh toán:
    - Backend xóa suất chiếu khỏi database
    - Hệ thống hiển thị thông báo "Hủy chương trình thành công"
    - Danh sách suất chiếu được làm mới
11. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu admin hủy xác nhận, đóng hộp thoại và kết thúc

**Rẽ nhánh 2:**
- 7.1 Nếu suất chiếu không tồn tại, hiển thị "Không tìm thấy chương trình" và kết thúc

**Rẽ nhánh 3:**
- 9.1 Nếu có người đã đặt vé (có occupiedSeats hoặc có booking đã thanh toán), hiển thị "Không thể hủy chương trình vì đã có người đặt vé" và kết thúc

---

### 3.2.1.4 Xem phim

**Hình 3-6 Use-case xem phim**

| Tên Use case | Xem Phim |
|--------------|----------|
| Actor | Người dùng (có thể chưa đăng nhập hoặc đã đăng nhập) |
| Mô tả | Người dùng xem thông tin về các phim, bao gồm danh sách phim, phim nổi bật, chi tiết phim và trailer. Một số tính năng yêu cầu đăng nhập (như yêu thích phim). |
| Pre-conditions | Hệ thống kết nối được với TMDB API. Database có dữ liệu phim hoặc có suất chiếu. |
| Post-conditions | **Success**: Người dùng xem được thông tin phim mong muốn. **Fail**: Hiển thị thông báo lỗi. |
| Luồng sự kiện chính | Người dùng chọn phim muốn xem. Hệ thống hiển thị trang chi tiết phim. - Extend Use Case Xem danh sách phim - Extend Use Case Phim nổi bật - Extend Use Case Xem chi tiết phim - Extend Use Case Xem trailer |
| Luồng sự kiện phụ | Actor nhấn nút Back hoặc Cancel. Hệ thống quay về trang trước đó. |

#### <Extend Use Case> Xem danh sách phim

1. Người dùng đang ở trang chủ hoặc menu "Phim"
2. Người dùng click vào menu "Phim" hoặc "Movies"
3. Hệ thống gửi yêu cầu lấy danh sách phim
4. Backend truy vấn database lấy tất cả phim có suất chiếu sắp tới
5. Backend sắp xếp theo ngày phát hành mới nhất
6. Hệ thống trả về danh sách phim
7. Frontend hiển thị danh sách phim dạng lưới (grid) với mỗi phim hiển thị:
   - Poster phim
   - Tên phim
   - Thể loại
   - Đánh giá (rating)
   - Nút "Xem chi tiết"
8. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu không có phim nào, hiển thị "Không tìm thấy phim"

#### <Extend Use Case> Phim nổi bật

1. Người dùng đang ở trang chủ
2. Hệ thống tự động hiển thị section "Phim nổi bật" hoặc "Featured Movies"
3. Hệ thống gửi yêu cầu lấy phim nổi bật
4. Backend truy vấn database lấy các phim có:
   - Đánh giá cao (vote_average ≥ 8.0)
   - Hoặc có nhiều suất chiếu sắp tới
5. Backend sắp xếp theo mức độ ưu tiên (rating giảm dần)
6. Backend lấy top 5-10 phim
7. Hệ thống trả về danh sách
8. Frontend hiển thị slider/carousel với các phim nổi bật:
   - Backdrop image lớn
   - Tên phim
   - Mô tả ngắn
   - Đánh giá
   - Nút "Xem ngay" hoặc "Đặt vé"
9. Slider tự động chuyển sau 5 giây
10. Người dùng có thể click mũi tên để chuyển phim
11. Kết thúc

#### <Extend Use Case> Xem chi tiết phim

1. Người dùng đang ở trang danh sách phim hoặc trang chủ
2. Người dùng click vào poster phim hoặc nút "Xem chi tiết"
3. Hệ thống gửi yêu cầu lấy thông tin chi tiết phim theo movieId
4. Backend kiểm tra phim có trong database không:
   - Nếu có: Lấy từ database
   - Nếu chưa có: Fetch từ TMDB API, lưu vào database và trả về
5. Backend lấy tất cả suất chiếu sắp tới của phim (showDateTime >= hiện tại)
6. Backend lọc các suất chiếu thuộc phòng chiếu có status = 'active'
7. Backend group suất chiếu theo ngày
8. Backend tính giá hiển thị cho mỗi suất chiếu:
   - Giá base = showPrice × hall.priceMultiplier
   - Có thể có phụ thu suất tối (sau 17h)
9. Backend kiểm tra trạng thái yêu thích (nếu người dùng đã đăng nhập):
   - Kiểm tra movieId có trong user.favoriteMovies không
10. Hệ thống trả về thông tin:
    - Thông tin phim: title, overview, poster_path, backdrop_path, genres, casts, vote_average, runtime, release_date, tagline, trailer_key
    - Danh sách suất chiếu group theo ngày
    - Trạng thái yêu thích (nếu đã đăng nhập)
11. Frontend hiển thị trang chi tiết phim với:
    - Backdrop image
    - Poster
    - Tên phim và thông tin cơ bản
    - Mô tả chi tiết
    - Đánh giá
    - Danh sách diễn viên, đạo diễn
    - Nút "Xem trailer"
    - Nút "Thêm vào yêu thích" (icon trái tim) - chỉ hiển thị nếu đã đăng nhập
    - Danh sách suất chiếu theo ngày với:
      - Ngày chiếu
      - Danh sách giờ chiếu với thông tin: giờ, phòng chiếu, giá vé
      - Nút "Chọn ghế" cho mỗi suất chiếu
12. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu fetch từ TMDB thất bại, hiển thị "Không tìm thấy thông tin phim"

#### <Extend Use Case> Xem trailer

1. Người dùng đang ở trang chi tiết phim
2. Người dùng click nút "Xem trailer" hoặc "Play Trailer"
3. Hệ thống kiểm tra trailer_key có tồn tại không
4. Nếu có trailer_key:
   - Hệ thống mở popup hoặc modal hiển thị video
   - Hệ thống nhúng video từ YouTube sử dụng trailer_key
   - Video trailer tự động phát
5. Người dùng xem trailer
6. Người dùng có thể:
   - Tạm dừng/phát
   - Điều chỉnh âm lượng
   - Xem toàn màn hình
   - Đóng popup
7. Kết thúc

**Rẽ nhánh 1:**
- 3.1 Nếu không có trailer_key hoặc trailer_key rỗng, hiển thị "Không thể phát trailer" hoặc ẩn nút "Xem trailer"

---

### 3.2.1.5 Quản lý đặt vé

**Hình 3-7 Use-case quản lý đặt vé**

| Tên Use case | Quản lý Đặt Vé |
|--------------|----------------|
| Actor | Người dùng đã đăng nhập |
| Mô tả | Người dùng thực hiện các thao tác đặt vé xem phim bao gồm chọn ghế, thanh toán, xem giá và đặt vé. Hệ thống xử lý race condition khi nhiều user đặt cùng ghế và tự động hủy booking chưa thanh toán sau 10 phút. |
| Pre-conditions | Người dùng đã đăng nhập thành công. Phim có suất chiếu khả dụng. Suất chiếu chưa hết ghế (còn ghế available). Phòng chiếu có status = 'active' (không phải maintenance). |
| Post-conditions | **Success**: Booking được tạo và thanh toán thành công, ghế được giữ. **Fail**: Ghế được giải phóng, booking bị hủy nếu không thanh toán trong 30 phút (Stripe session expires) hoặc 10 phút (Inngest auto-cancel). |
| Luồng sự kiện chính | Người dùng chọn suất chiếu muốn đặt. Hệ thống hiển thị trang chọn ghế. - Extend Use Case Chọn ghế - Extend Use Case Xem giá - Extend Use Case Đặt vé - Extend Use Case Thanh toán |
| Luồng sự kiện phụ | Actor nhấn nút Back hoặc Cancel. Hệ thống quay về trang chi tiết phim. |

#### <Extend Use Case> Chọn ghế

1. Người dùng vào trang đặt vé (từ trang chi tiết phim, chọn suất chiếu)
2. Hệ thống gửi yêu cầu lấy thông tin suất chiếu và phòng chiếu
3. Backend truy vấn database lấy:
   - Thông tin suất chiếu (showDateTime, showPrice, occupiedSeats)
   - Thông tin phòng chiếu (seatLayout, customRowSeats, brokenSeats, priceMultiplier)
4. Backend kiểm tra phòng chiếu có status = 'active' không
5. Hệ thống trả về thông tin sơ đồ ghế
6. Frontend hiển thị sơ đồ ghế ngồi (seat map) của rạp với:
   - Các dãy ghế (rows) theo seatLayout
   - Số ghế mỗi dãy (seatsPerRow hoặc customRowSeats)
   - Đánh dấu ghế đã được đặt (từ occupiedSeats) - màu xám, disabled
   - Đánh dấu ghế hỏng (từ brokenSeats) - màu đỏ, disabled
   - Đánh dấu ghế đôi (từ coupleSeatsRows) - hiển thị đặc biệt
7. Người dùng click chọn ghế ngồi mong muốn
8. Hệ thống kiểm tra ghế có khả dụng không:
   - Ghế chưa được đặt (không có trong occupiedSeats)
   - Ghế không bị hỏng (không có trong brokenSeats)
9. Nếu ghế khả dụng:
   - Hệ thống thêm ghế vào danh sách ghế đã chọn (selectedSeats)
   - Frontend cập nhật giao diện, đánh dấu ghế đã chọn (màu xanh)
   - Nếu là ghế đôi, tự động chọn cả cặp ghế
10. Người dùng có thể tiếp tục chọn thêm ghế (tối đa 5 ghế) hoặc bỏ chọn ghế
11. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu phòng chiếu đang bảo trì, hiển thị "Phòng chiếu đang bảo trì" và quay về trang trước
- 5.1 Nếu ghế đã bị người dùng khác đặt (race condition), hệ thống hiển thị thông báo "Ghế đã được đặt" và cập nhật lại sơ đồ ghế, quay lại bước 6
- 5.2 Nếu ghế bị hỏng, hiển thị "Ghế này đang bảo trì, không thể đặt" và không cho chọn

**Rẽ nhánh 2:**
- 10.1 Nếu người dùng chọn quá 5 ghế, hiển thị "Chỉ có thể chọn tối đa 5 ghế" và không cho chọn thêm

#### <Extend Use Case> Xem giá

1. Người dùng đã chọn ít nhất một ghế
2. Hệ thống tự động tính toán và hiển thị tổng tiền phải thanh toán:
   - Giá base = showPrice × hall.priceMultiplier
   - Phụ thu ghế đôi = 10,000 VNĐ (nếu ghế thuộc dãy coupleSeatsRows)
   - Phụ thu suất tối = 10,000 VNĐ (nếu showDateTime >= 17:00)
   - Tổng tiền = Σ (giá base + phụ thu ghế đôi + phụ thu suất tối) cho mỗi ghế
3. Hệ thống hiển thị chi tiết:
   - Số ghế đã chọn
   - Giá từng ghế (nếu có phụ thu thì hiển thị rõ)
   - Tổng tiền
4. Kết thúc

#### <Extend Use Case> Đặt vé

1. Sau khi chọn ghế và kiểm tra giá, người dùng nhấn nút "Thanh toán"
2. Hệ thống gửi yêu cầu tạo booking
3. Backend xác thực danh tính người dùng (JWT token)
4. Backend kiểm tra lại tất cả các ghế đã chọn có còn khả dụng không:
   - Truy vấn Show.occupiedSeats
   - Kiểm tra từng ghế trong selectedSeats
5. Nếu tất cả ghế còn khả dụng:
   - Backend tính toán lại tổng tiền (giống bước Xem giá)
   - Backend tạo Booking record với:
     - user: userId
     - show: showId
     - amount: totalAmount
     - bookedSeats: selectedSeats
     - ispaid: false
     - status: 'active'
   - Backend cập nhật Show.occupiedSeats: thêm các ghế đã chọn với value = userId
   - Backend lưu Show
6. Backend tạo Stripe Checkout Session:
   - line_items: Tên phim, tổng tiền
   - metadata: bookingId
   - success_url: /loading/my-bookings
   - cancel_url: /my-bookings
   - expires_at: 30 phút
7. Backend lưu paymentLink vào Booking
8. Backend trigger Inngest event `app/checkpayment` với bookingId
9. Inngest sẽ đợi 10 phút và kiểm tra thanh toán
10. Backend trả về URL thanh toán Stripe
11. Frontend chuyển hướng người dùng đến Stripe Checkout
12. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu trong lúc kiểm tra, một hoặc nhiều ghế đã bị người khác đặt trước (race condition), backend trả về lỗi "Một hoặc nhiều ghế đã chọn đã được đặt. Vui lòng chọn ghế khác", frontend cập nhật lại sơ đồ ghế và yêu cầu người dùng chọn lại

**Rẽ nhánh 2:**
- 6.1 Nếu tạo Stripe session thất bại, rollback (xóa booking, giải phóng ghế) và hiển thị "Không thể tạo phiên thanh toán. Vui lòng thử lại."

#### <Extend Use Case> Thanh toán

1. Sau khi booking được tạo thành công, hệ thống chuyển hướng người dùng đến trang thanh toán Stripe Checkout
2. Người dùng nhập thông tin thanh toán trên Stripe:
   - Số thẻ tín dụng
   - Thông tin thẻ (MM/YY, CVC)
   - Hoặc chọn phương thức thanh toán khác (nếu Stripe hỗ trợ)
3. Người dùng xác nhận thanh toán
4. Stripe xử lý giao dịch
5. Nếu thanh toán thành công:
   - Stripe gửi webhook event `payment_intent.succeeded` về `/api/stripe`
   - Backend verify webhook signature
   - Backend tìm booking theo bookingId trong metadata
   - Backend cập nhật Booking:
     - ispaid: true
     - paymentLink: "" (xóa link)
   - Backend trigger Inngest event `app/show.booked` để gửi email xác nhận
   - Inngest gửi email xác nhận đặt vé đến người dùng
6. Stripe chuyển hướng người dùng về success_url: `/loading/my-bookings`
7. Frontend hiển thị trang loading và sau đó chuyển đến `/my-bookings`
8. Người dùng xem danh sách booking với vé vừa đặt (ispaid = true)
9. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Thanh toán thất bại: Nếu giao dịch bị từ chối (thẻ hết hạn, không đủ tiền, v.v.), Stripe hiển thị thông báo lỗi trên trang Checkout, người dùng có thể thử lại hoặc hủy
- 4.2 Nếu người dùng hủy thanh toán, Stripe chuyển hướng về cancel_url: `/my-bookings`, booking vẫn còn với ispaid = false

**Rẽ nhánh 2:**
- 5.1 Nếu webhook thất bại hoặc không nhận được, booking vẫn ở trạng thái ispaid = false, Inngest sẽ tự động hủy sau 10 phút và giải phóng ghế

**Rẽ nhánh 3:**
- 5.2 Nếu Stripe session hết hạn (30 phút) mà chưa thanh toán, booking vẫn ở trạng thái ispaid = false, Inngest sẽ tự động hủy sau 10 phút và giải phóng ghế

---

### 3.2.1.6 Quản lý booking cá nhân

**Hình 3-8 Use case quản lý booking cá nhân**

| Tên Use case | Quản lý Booking Cá Nhân |
|--------------|------------------------|
| Actor | Người dùng đã đăng nhập |
| Mô tả | Người dùng quản lý các booking và phim yêu thích của chính mình, bao gồm danh sách phim đã đánh dấu yêu thích và xem lịch sử đặt vé của bản thân. |
| Pre-conditions | Người dùng đã đăng nhập thành công vào hệ thống. Người dùng có tài khoản hợp lệ. |
| Post-conditions | **Success**: Người dùng xem được danh sách phim yêu thích và lịch sử đặt vé của mình. **Fail**: Hiển thị thông báo lỗi phù hợp. |
| Luồng sự kiện chính | Actor truy cập hệ thống. Hệ thống hiển thị giao diện chức năng quản lý. - Extend Use Case Phim yêu thích - Extend Use Case Lịch sử đặt vé |
| Luồng sự kiện phụ | Actor nhấn nút Thoát. Hệ thống quay về trang chủ. |

#### <Extend Use Case> Phim yêu thích

1. Người dùng đang ở trang quản lý cá nhân hoặc menu "Yêu thích"
2. Người dùng chọn chức năng "Phim yêu thích" hoặc click vào tab "Favorites"
3. Hệ thống gửi yêu cầu lấy danh sách phim yêu thích của người dùng
4. Backend xác thực token người dùng
5. Backend kiểm tra quyền truy cập (chỉ lấy phim yêu thích của chính người dùng)
6. Backend truy vấn database:
   - Tìm user theo userId
   - Lấy mảng favoriteMovies (chứa các movieId)
   - Populate thông tin phim từ database
7. Backend sắp xếp danh sách theo thời gian đánh dấu gần nhất (hoặc theo tên phim)
8. Hệ thống trả về danh sách phim yêu thích
9. Frontend hiển thị danh sách phim với thông tin:
   - Poster phim
   - Tên phim
   - Thể loại
   - Đánh giá
   - Nút "Xem chi tiết"
10. Người dùng có thể click vào phim để xem chi tiết
11. Người dùng có thể bỏ yêu thích bằng cách click vào biểu tượng trái tim (từ trang chi tiết phim)
12. Kết thúc

**Rẽ nhánh 1:**
- 6.1 Nếu người dùng chưa đánh dấu phim nào, hệ thống trả về danh sách rỗng và hiển thị "Bạn chưa có phim yêu thích nào"

**Rẽ nhánh 2:**
- 11.1 Người dùng click vào biểu tượng trái tim để bỏ yêu thích:
    - Hệ thống gửi yêu cầu cập nhật favorite
    - Backend xác thực người dùng
    - Backend tìm movieId trong user.favoriteMovies
    - Backend xóa movieId khỏi mảng favoriteMovies
    - Backend lưu user
    - Hệ thống cập nhật giao diện (trái tim chuyển từ đỏ sang trắng)

**Rẽ nhánh 3:**
- 11.2 Nếu API lỗi, hiển thị thông báo lỗi, retry tự động sau 3 giây

#### <Extend Use Case> Lịch sử đặt vé

1. Người dùng đang ở trang quản lý cá nhân hoặc menu "Đặt chỗ của tôi"
2. Người dùng chọn chức năng "Lịch sử đặt vé" hoặc click vào "My Bookings"
3. Hệ thống gửi yêu cầu lấy danh sách booking của người dùng
4. Backend xác thực token người dùng
5. Backend kiểm tra quyền truy cập (chỉ lấy booking của chính người dùng)
6. Backend truy vấn database lấy các booking:
   - user = userId
   - Populate thông tin: show, show.movie, show.hall
   - Sắp xếp theo createdAt giảm dần (mới nhất trước)
7. Backend phân loại booking theo trạng thái:
   - Active & Paid: Đã thanh toán, chưa hủy, suất chiếu chưa diễn ra
   - Active & Pending: Chưa thanh toán, chưa hết hạn
   - Cancelled: Đã hủy
   - Expired: Chưa thanh toán và đã quá 10 phút (có thể đã bị Inngest xóa)
8. Hệ thống trả về danh sách booking đã phân loại
9. Frontend hiển thị danh sách booking với thông tin:
   - Tên phim
   - Ngày giờ chiếu
   - Phòng chiếu
   - Số ghế đã đặt
   - Tổng tiền
   - Trạng thái (Đã thanh toán / Chờ thanh toán / Đã hủy)
   - Nút "Hủy vé" (nếu có thể hủy)
   - Link thanh toán (nếu chưa thanh toán và chưa hết hạn)
10. Người dùng có thể:
    - Xem chi tiết booking
    - Hủy vé (nếu đáp ứng điều kiện)
    - Thanh toán lại (nếu chưa thanh toán và chưa hết hạn)
11. Kết thúc

**Rẽ nhánh 1:**
- 6.1 Nếu người dùng chưa đặt vé lần nào, hệ thống trả về danh sách rỗng và hiển thị "Bạn chưa có đặt chỗ nào"

---

### 3.2.1.7 Quản lý booking

**Hình 3-9 Use case quản lý booking**

| Tên Use case | Quản lý Booking |
|--------------|-----------------|
| Actor | Admin (Người quản trị) |
| Mô tả | Admin xem và quản lý tất cả các booking trong hệ thống, bao gồm cả booking đã thanh toán và chưa thanh toán. |
| Pre-conditions | Admin đăng nhập với quyền quản trị (privateMetadata.role === 'admin'). |
| Post-conditions | **Success**: Admin xem được danh sách booking và thực hiện các thao tác quản lý. **Fail**: Hiển thị thông báo lỗi phù hợp. |
| Luồng sự kiện chính | Actor truy cập hệ thống. Hệ thống hiển thị giao diện chức năng quản lý. - Extend Use Case Xem tổng booking |
| Luồng sự kiện phụ | Actor nhấn nút Thoát. Hệ thống quay về trang admin dashboard. |

#### <Extend Use Case> Xem tổng booking

1. Admin đang ở trang quản lý booking hoặc menu "Danh sách đặt chỗ"
2. Admin chọn "Xem tổng booking" hoặc trang tự động load
3. Hệ thống gửi yêu cầu lấy danh sách booking
4. Backend xác thực quyền admin (middleware protectAdmin)
5. Backend truy vấn database lấy tất cả booking:
   - Populate thông tin: user, show, show.movie, show.hall
   - Sắp xếp theo createdAt giảm dần (mới nhất trước)
6. Backend tính thống kê cơ bản:
   - Tổng số booking
   - Số booking đã thanh toán (ispaid = true, status != 'cancelled')
   - Số booking chờ thanh toán (ispaid = false, status = 'active')
   - Tổng doanh thu (tổng amount của các booking đã thanh toán)
7. Backend phân loại theo trạng thái:
   - Paid: Đã thanh toán (ispaid = true, status = 'active')
   - Pending: Chờ thanh toán (ispaid = false, status = 'active')
   - Cancelled: Đã hủy (status = 'cancelled')
8. Hệ thống trả về danh sách và thống kê
9. Frontend hiển thị thống kê tổng quan:
   - Card "Tổng số booking"
   - Card "Đã thanh toán"
   - Card "Chờ thanh toán"
   - Card "Tổng doanh thu"
10. Frontend hiển thị bảng danh sách booking với thông tin:
    - Booking ID
    - Tên người dùng
    - Tên phim
    - Ngày giờ chiếu
    - Phòng chiếu
    - Số ghế
    - Tổng tiền
    - Trạng thái (Đã thanh toán / Chờ thanh toán / Đã hủy)
    - Thời gian tạo
11. Admin có thể:
    - Tìm kiếm theo booking ID hoặc tên người dùng
    - Lọc theo trạng thái (Paid/Pending/Cancelled)
    - Lọc theo khoảng thời gian
    - Sắp xếp theo cột
12. Admin có thể thực hiện thao tác:
    - Xem chi tiết booking
    - Xuất báo cáo (nếu có chức năng)
13. Kết thúc

**Rẽ nhánh 1:**
- 5.1 Nếu chưa có booking thì hiển thị danh sách trống và thống kê = 0

---

### 3.2.1.8 Thống kê

**Hình 3-10 Use case thống kê**

| Tên Use case | Thống kê |
|--------------|----------|
| Actor | Admin |
| Mô tả | Admin xem các thống kê của hệ thống bao gồm tổng người dùng, doanh thu, số ghế đã đặt và phim đang chiếu. Hệ thống hỗ trợ lọc theo khoảng thời gian (today, thisMonth, lastMonth, custom range). |
| Pre-conditions | Admin đã đăng nhập với quyền quản trị. Hệ thống có dữ liệu. |
| Post-conditions | **Success**: Admin xem được các thống kê tổng quan. **Fail**: Hiển thị thông báo lỗi phù hợp. |
| Luồng sự kiện chính | Admin đăng nhập và truy cập admin dashboard. - Extend Use Case Tổng người dùng - Extend Use Case Tổng doanh thu - Extend Use Case Tổng số ghế đặt - Extend Use Case Phim đang chiếu |
| Luồng sự kiện phụ | Admin nhấn nút Logout. Hệ thống đăng xuất và quay về trang chủ. |

#### <Extend Use Case> Tổng người dùng

1. Admin truy cập trang dashboard
2. Hệ thống gửi yêu cầu lấy thống kê người dùng
3. Backend xác thực quyền admin
4. Backend đếm tổng số người dùng trong database (User collection)
5. Backend tính thêm:
   - Số người dùng mới trong tháng hiện tại
   - Số người dùng hoạt động (đã đặt vé ít nhất 1 lần)
6. Hệ thống trả về kết quả
7. Frontend hiển thị card "Tổng người dùng" với số liệu
8. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu lỗi database, thông báo lỗi và hiển thị "N/A"

#### <Extend Use Case> Tổng doanh thu

1. Admin truy cập trang dashboard
2. Hệ thống gửi yêu cầu lấy thống kê doanh thu (có thể kèm theo period: today, thisMonth, lastMonth, custom)
3. Backend xác thực quyền admin
4. Backend lấy tất cả booking đã thanh toán (ispaid = true, status != 'cancelled')
5. Backend lọc theo khoảng thời gian (nếu có):
   - today: Bookings tạo trong ngày hôm nay
   - thisMonth: Bookings tạo trong tháng này
   - lastMonth: Bookings tạo trong tháng trước
   - custom: Bookings tạo trong khoảng startDate - endDate
6. Backend tính tổng doanh thu = Σ(amount) của các booking đã lọc
7. Backend tính thêm:
   - Doanh thu hôm nay
   - Doanh thu tháng này
   - Doanh thu năm nay
8. Hệ thống trả về kết quả
9. Frontend hiển thị card "Tổng doanh thu" với số liệu
10. Frontend hiển thị biểu đồ doanh thu theo thời gian (nếu có)
11. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu không có booking đã thanh toán, tổng doanh thu = 0

#### <Extend Use Case> Tổng số ghế đặt

1. Admin truy cập trang dashboard
2. Hệ thống gửi yêu cầu lấy thống kê ghế
3. Backend xác thực quyền admin
4. Backend đếm tổng số ghế đã đặt từ tất cả booking đã thanh toán:
   - Lấy tất cả booking với ispaid = true, status != 'cancelled'
   - Đếm tổng số phần tử trong bookedSeats của tất cả booking
5. Backend tính thêm:
   - Số ghế đã đặt hôm nay (từ booking tạo hôm nay)
   - Số ghế đã đặt tháng này (từ booking tạo trong tháng này)
   - Tỷ lệ lấp đầy trung bình = (tổng ghế đã đặt) / (tổng ghế có thể đặt)
6. Hệ thống trả về kết quả
7. Frontend hiển thị card "Tổng số ghế đặt" với số liệu
8. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu không có booking nào, tổng số ghế đặt = 0

#### <Extend Use Case> Phim đang chiếu

1. Admin truy cập trang dashboard
2. Hệ thống gửi yêu cầu lấy danh sách phim đang chiếu
3. Backend xác thực quyền admin
4. Backend lọc phim có suất chiếu trong khoảng thời gian hiện tại:
   - Lấy tất cả Show có showDateTime >= hiện tại
   - Lọc các Show thuộc phòng chiếu có status = 'active'
   - Group theo movie để lấy danh sách phim unique
5. Backend đếm tổng số phim đang chiếu
6. Backend tính thêm cho mỗi phim:
   - Số lượt đặt vé (từ booking đã thanh toán)
   - Doanh thu từ phim (tổng amount của booking đã thanh toán)
   - Tỷ lệ lấp đầy (số ghế đã đặt / tổng ghế có thể đặt)
7. Backend sắp xếp theo số lượt đặt vé giảm dần
8. Hệ thống trả về kết quả
9. Frontend hiển thị card "Phim đang chiếu" với số lượng
10. Frontend hiển thị danh sách top phim được đặt nhiều nhất (nếu có)
11. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu không có suất chiếu nào, số phim đang chiếu = 0

---

### 3.2.1.9 Quản lý phòng chiếu (Bổ sung)

**Hình 3-11 Use case quản lý phòng chiếu**

| Tên Use case | Quản lý Phòng Chiếu |
|--------------|---------------------|
| Actor | Admin (Người quản trị) |
| Mô tả | Admin quản lý các phòng chiếu trong rạp, bao gồm thêm phòng mới, xem danh sách phòng, cập nhật thông tin phòng, đặt trạng thái bảo trì. |
| Pre-conditions | Admin đăng nhập với quyền quản trị (privateMetadata.role === 'admin'). |
| Post-conditions | **Success**: Dữ liệu phòng chiếu được cập nhật chính xác. **Fail**: Hiển thị thông báo lỗi phù hợp. |
| Luồng sự kiện chính | Admin truy cập trang quản lý phòng chiếu. - Extend Use Case Xem danh sách phòng chiếu - Extend Use Case Thêm phòng chiếu - Extend Use Case Cập nhật phòng chiếu - Extend Use Case Đặt trạng thái bảo trì |
| Luồng sự kiện phụ | Actor nhấn nút Thoát. Hệ thống quay về trang admin dashboard. |

**Mô tả quy trình:** Khi quản trị viên truy cập vào giao diện 'Danh sách phòng chiếu', hệ thống sẽ thực hiện truy xuất toàn bộ dữ liệu phòng chiếu hiện có trong cơ sở dữ liệu, đồng thời liên kết đầy đủ với các thông tin chi tiết về cấu trúc ghế, suất chiếu đã được lên lịch và thống kê sử dụng. Danh sách kết quả được tự động sắp xếp theo thứ tự thời gian tạo từ mới nhất đến cũ nhất và trình bày dưới dạng bảng thống kê, bao gồm các cột thông tin: tên phòng, số phòng, loại phòng (Standard/VIP/IMAX), tổng số ghế, số ghế đã đặt, số ghế còn trống, hệ số giá, trạng thái hoạt động (đang hoạt động/bảo trì), thời gian tạo và thời gian cập nhật gần nhất. Để hỗ trợ công tác quản lý và báo cáo hiệu quả, hệ thống tích hợp bộ công cụ cho phép quản trị viên lọc dữ liệu theo trạng thái hoạt động, lọc theo loại phòng, tìm kiếm nhanh dựa trên tên phòng hoặc số phòng, xem chi tiết từng phòng chiếu (bao gồm sơ đồ ghế, lịch sử suất chiếu, thống kê sử dụng) và thực hiện xuất dữ liệu thống kê ra các định dạng tệp thông dụng như CSV hoặc PDF.

**Các bước thực hiện:**

1. Quản trị viên đăng nhập vào trang website

2. Chọn quản lý phòng chiếu

3. Quản lý xem thông tin

#### <Extend Use Case> Xem danh sách phòng chiếu

1. Admin đang ở trang quản lý phòng chiếu hoặc menu "Danh sách phòng chiếu"
2. Admin chọn "Xem danh sách phòng chiếu" hoặc trang tự động load
3. Hệ thống gửi yêu cầu lấy danh sách phòng chiếu
4. Backend xác thực quyền admin (middleware protectAdmin)
5. Backend truy vấn database lấy tất cả phòng chiếu:
   - Populate thông tin: seatLayout, customRowSeats, brokenSeats, coupleSeatsRows
   - Sắp xếp theo createdAt giảm dần (mới nhất trước)
6. Backend tính toán thống kê cho mỗi phòng chiếu:
   - Tổng số ghế = tính từ seatLayout và customRowSeats
   - Số ghế đã đặt = đếm từ tất cả suất chiếu (Show) liên quan đến phòng này, tổng hợp occupiedSeats
   - Số ghế còn trống = tổng số ghế - số ghế đã đặt - số ghế hỏng (brokenSeats)
   - Số suất chiếu sắp tới = đếm Show có showDateTime >= hiện tại và hall = phòng này
7. Backend tính thống kê tổng quan:
   - Tổng số phòng chiếu
   - Số phòng đang hoạt động (status = 'active')
   - Số phòng đang bảo trì (status = 'maintenance')
   - Tổng số ghế trong toàn hệ thống
   - Tỷ lệ sử dụng trung bình = (tổng ghế đã đặt) / (tổng ghế có thể đặt)
8. Backend phân loại theo trạng thái:
   - Active: Đang hoạt động (status = 'active')
   - Maintenance: Đang bảo trì (status = 'maintenance')
9. Hệ thống trả về danh sách và thống kê
10. Frontend hiển thị thống kê tổng quan:
    - Card "Tổng số phòng chiếu"
    - Card "Phòng đang hoạt động"
    - Card "Phòng đang bảo trì"
    - Card "Tổng số ghế"
    - Card "Tỷ lệ sử dụng trung bình"
11. Frontend hiển thị bảng danh sách phòng chiếu với thông tin:
    - Tên phòng
    - Số phòng
    - Loại phòng (Standard/VIP/IMAX)
    - Tổng số ghế
    - Số ghế đã đặt
    - Số ghế còn trống
    - Hệ số giá (priceMultiplier)
    - Trạng thái (Đang hoạt động / Đang bảo trì)
    - Thời gian tạo
    - Thời gian cập nhật gần nhất
12. Admin có thể:
    - Tìm kiếm theo tên phòng hoặc số phòng
    - Lọc theo trạng thái (Active/Maintenance)
    - Lọc theo loại phòng (Standard/VIP/IMAX)
    - Sắp xếp theo cột (tên, số phòng, tổng ghế, trạng thái, thời gian tạo)
13. Admin có thể thực hiện thao tác:
    - Xem chi tiết phòng chiếu (sơ đồ ghế, lịch sử suất chiếu, thống kê sử dụng)
    - Thêm phòng chiếu mới
    - Cập nhật thông tin phòng chiếu
    - Đặt trạng thái bảo trì
    - Xuất báo cáo (CSV/PDF)
14. Kết thúc

**Rẽ nhánh 1:**
- 5.1 Nếu chưa có phòng chiếu nào thì hiển thị danh sách trống và thống kê = 0

#### <Extend Use Case> Thêm phòng chiếu

1. Admin chọn "Thêm phòng chiếu"
2. Hệ thống hiển thị form thêm phòng
3. Admin nhập thông tin:
   - Tên phòng
   - Số phòng (phải unique)
   - Loại phòng (Standard/VIP/IMAX)
   - Cấu trúc ghế (rows, seatsPerRow, coupleSeatsRows, layoutType)
   - Số ghế tùy chỉnh theo dãy (nếu có)
   - Hệ số giá
4. Hệ thống kiểm tra tính hợp lệ:
   - Số phòng chưa tồn tại
   - Tổng số ghế > 0
   - Hệ số giá > 0
5. Backend tạo CinemaHall record
6. Hệ thống hiển thị "Thêm phòng chiếu thành công"
7. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu số phòng đã tồn tại, hiển thị "Số phòng đã tồn tại" và quay lại bước 3

#### <Extend Use Case> Cập nhật phòng chiếu

1. Admin chọn phòng chiếu cần cập nhật
2. Hệ thống hiển thị form với thông tin hiện tại
3. Admin chỉnh sửa thông tin (tên, loại, cấu trúc ghế, hệ số giá)
4. Backend cập nhật CinemaHall record
5. Hệ thống hiển thị "Cập nhật thành công"
6. Kết thúc

#### <Extend Use Case> Đặt trạng thái bảo trì

1. Admin chọn phòng chiếu cần đặt bảo trì
2. Admin chọn "Đặt bảo trì"
3. Hệ thống hiển thị form nhập thông tin bảo trì:
   - Ghi chú bảo trì
   - Ngày bắt đầu
   - Ngày kết thúc dự kiến
4. Backend cập nhật CinemaHall:
   - status: 'maintenance'
   - maintenanceNote: ghi chú
   - maintenanceStartDate: ngày bắt đầu
   - maintenanceEndDate: ngày kết thúc
5. Hệ thống tự động vô hiệu hóa tất cả suất chiếu trong phòng này (không cho đặt vé)
6. Hệ thống hiển thị "Đã đặt phòng chiếu vào chế độ bảo trì"
7. Kết thúc

---

### 3.2.1.10 Hủy đặt chỗ (Bổ sung)

| Tên Use case | Hủy Đặt Chỗ |
|--------------|-------------|
| Actor | Người dùng đã đăng nhập |
| Mô tả | Người dùng hủy đặt chỗ đã thanh toán. Hệ thống tính toán phần trăm hoàn tiền dựa trên thời gian hủy so với thời gian suất chiếu. |
| Pre-conditions | Người dùng đã đăng nhập. Booking tồn tại và thuộc về người dùng. Booking đã thanh toán (ispaid = true). Suất chiếu chưa diễn ra. |
| Post-conditions | **Success**: Booking được hủy, ghế được giải phóng, hoàn tiền (nếu đủ điều kiện). **Fail**: Hiển thị thông báo lỗi. |
| Luồng sự kiện chính | Người dùng chọn booking cần hủy. Hệ thống hiển thị xác nhận hủy. Người dùng xác nhận. Hệ thống hủy booking và hoàn tiền. |

1. Người dùng đang ở trang "Lịch sử đặt vé"
2. Người dùng chọn booking cần hủy và nhấn nút "Hủy vé"
3. Hệ thống hiển thị hộp thoại xác nhận với thông tin:
   - Tên phim
   - Ngày giờ chiếu
   - Số ghế
   - Tổng tiền
   - Phần trăm hoàn tiền dự kiến
4. Người dùng xác nhận hủy
5. Hệ thống gửi yêu cầu hủy booking
6. Backend xác thực người dùng
7. Backend kiểm tra booking:
   - Booking tồn tại
   - Booking thuộc về người dùng
   - Booking chưa bị hủy (status != 'cancelled')
   - Suất chiếu chưa diễn ra (showDateTime > hiện tại)
8. Backend tính phần trăm hoàn tiền:
   - ≥ 24 giờ trước suất chiếu: 80%
   - 12-24 giờ trước: 50%
   - 6-12 giờ trước: 20%
   - < 6 giờ trước: 0% (không cho hủy)
9. Nếu phần trăm hoàn tiền = 0:
   - Backend từ chối hủy
   - Hệ thống hiển thị "Không thể hủy vé trong vòng 6 giờ trước suất chiếu"
   - Kết thúc
10. Nếu phần trăm hoàn tiền > 0:
    - Backend tính số tiền hoàn lại = amount × (refundPercentage / 100)
    - Backend giải phóng ghế: Xóa các ghế khỏi Show.occupiedSeats
    - Backend cập nhật Booking:
      - status: 'cancelled'
      - cancelledAt: hiện tại
      - refundPercentage: phần trăm hoàn tiền
      - refundAmount: số tiền hoàn lại
    - Backend lưu Show và Booking
    - Backend trigger Inngest event `app/booking.cancelled` để gửi email thông báo
    - Inngest gửi email thông báo hủy vé và thông tin hoàn tiền
11. Hệ thống hiển thị "Hủy vé thành công. Bạn được hoàn X% (Y VNĐ)"
12. Danh sách booking được làm mới
13. Kết thúc

**Rẽ nhánh 1:**
- 4.1 Nếu người dùng hủy xác nhận, đóng hộp thoại và kết thúc

**Rẽ nhánh 2:**
- 7.1 Nếu booking không tồn tại, hiển thị "Không tìm thấy đặt vé" và kết thúc
- 7.2 Nếu booking không thuộc về người dùng, hiển thị "Bạn không có quyền hủy vé này" và kết thúc
- 7.3 Nếu booking đã bị hủy, hiển thị "Vé này đã được hủy trước đó" và kết thúc
- 7.4 Nếu suất chiếu đã diễn ra, hiển thị "Không thể hủy vé sau khi suất chiếu đã bắt đầu" và kết thúc

**Rẽ nhánh 3:**
- 10.1 Nếu booking chưa thanh toán (ispaid = false), backend xóa booking và giải phóng ghế, không tính hoàn tiền, không gửi email

**Lưu ý:** Hiện tại hệ thống chưa tích hợp Stripe Refund API để hoàn tiền thực sự. Chỉ tính toán và lưu thông tin hoàn tiền. Để hoàn tiền thực sự, cần:
- Lưu paymentIntentId vào Booking khi thanh toán thành công
- Gọi Stripe Refund API với paymentIntentId khi hủy vé

