# üí∞ T√ÄI LI·ªÜU PH·∫¢N BI·ªÜN: CH√çNH S√ÅCH HO√ÄN TI·ªÄN

## üìã M·ª§C L·ª§C
1. [T·ªïng quan nghi·ªáp v·ª•](#1-t·ªïng-quan-nghi·ªáp-v·ª•)
2. [Ch√≠nh s√°ch ho√†n ti·ªÅn](#2-ch√≠nh-s√°ch-ho√†n-ti·ªÅn)
3. [C·∫•u tr√∫c d·ªØ li·ªáu](#3-c·∫•u-tr√∫c-d·ªØ-li·ªáu)
4. [Lu·ªìng nghi·ªáp v·ª•](#4-lu·ªìng-nghi·ªáp-v·ª•)
5. [Code li√™n quan](#5-code-li√™n-quan)
6. [C√¢u h·ªèi th∆∞·ªùng g·∫∑p khi ph·∫£n bi·ªán](#6-c√¢u-h·ªèi-th∆∞·ªùng-g·∫∑p-khi-ph·∫£n-bi·ªán)

---

## 1. T·ªîNG QUAN NGHI·ªÜP V·ª§

### 1.1. M·ª•c ƒë√≠ch
H·ªá th·ªëng ch√≠nh s√°ch ho√†n ti·ªÅn cho ph√©p:
- **H·ªßy v√© linh ho·∫°t**: User c√≥ th·ªÉ h·ªßy v√© tr∆∞·ªõc su·∫•t chi·∫øu
- **T√≠nh ho√†n ti·ªÅn t·ª± ƒë·ªông**: D·ª±a tr√™n th·ªùi gian h·ªßy so v·ªõi gi·ªù chi·∫øu
- **B·∫£o v·ªá quy·ªÅn l·ª£i**: Ho√†n ti·ªÅn theo t·ª∑ l·ªá c√¥ng b·∫±ng
- **Email t·ª± ƒë·ªông**: G·ª≠i email x√°c nh·∫≠n h·ªßy v√† th√¥ng tin ho√†n ti·ªÅn

### 1.2. ƒê·∫∑c ƒëi·ªÉm n·ªïi b·∫≠t
‚úÖ **T√≠nh to√°n t·ª± ƒë·ªông**: H·ªá th·ªëng t·ª± t√≠nh % ho√†n ti·ªÅn d·ª±a tr√™n th·ªùi gian  
‚úÖ **Validation th√¥ng minh**: Kh√¥ng cho h·ªßy d∆∞·ªõi 6h, kh√¥ng h·ªßy sau khi show ƒë√£ b·∫Øt ƒë·∫ßu  
‚úÖ **X·ª≠ l√Ω 2 tr∆∞·ªùng h·ª£p**: V√© ch∆∞a thanh to√°n (x√≥a lu√¥n) vs V√© ƒë√£ thanh to√°n (t√≠nh ho√†n ti·ªÅn)  
‚úÖ **Email t·ª± ƒë·ªông**: G·ª≠i email x√°c nh·∫≠n v·ªõi th√¥ng tin chi ti·∫øt  
‚úÖ **Gi·∫£i ph√≥ng gh·∫ø**: T·ª± ƒë·ªông gi·∫£i ph√≥ng gh·∫ø khi h·ªßy  

---

## 2. CH√çNH S√ÅCH HO√ÄN TI·ªÄN

### 2.1. B·∫£ng T·ª∑ L·ªá Ho√†n Ti·ªÅn

| Th·ªùi gian h·ªßy tr∆∞·ªõc su·∫•t chi·∫øu | T·ª∑ l·ªá ho√†n ti·ªÅn | M√¥ t·∫£ |
|-------------------------------|-----------------|-------|
| **‚â• 24 gi·ªù** | **80%** | Ho√†n cao nh·∫•t, khuy·∫øn kh√≠ch h·ªßy s·ªõm |
| **12 - 24 gi·ªù** | **50%** | Ho√†n m·ªôt n·ª≠a, ph√≠ h·ªßy 50% |
| **6 - 12 gi·ªù** | **20%** | G·∫ßn gi·ªù chi·∫øu, ph√≠ h·ªßy cao |
| **< 6 gi·ªù** | **0%** | Kh√¥ng ƒë∆∞·ª£c h·ªßy | 

### 2.2. Quy T·∫Øc Quan Tr·ªçng

**‚úÖ ƒê∆∞·ª£c h·ªßy khi:**
- C√≤n ‚â• 6 gi·ªù tr∆∞·ªõc su·∫•t chi·∫øu
- V√© ch∆∞a b·∫Øt ƒë·∫ßu chi·∫øu
- V√© ch∆∞a ƒë∆∞·ª£c h·ªßy tr∆∞·ªõc ƒë√≥

**‚ùå Kh√¥ng ƒë∆∞·ª£c h·ªßy khi:**
- D∆∞·ªõi 6 gi·ªù tr∆∞·ªõc su·∫•t chi·∫øu
- Sau khi su·∫•t chi·∫øu ƒë√£ b·∫Øt ƒë·∫ßu
- V√© ƒë√£ ƒë∆∞·ª£c h·ªßy tr∆∞·ªõc ƒë√≥

### 2.3. X·ª≠ L√Ω 2 Tr∆∞·ªùng H·ª£p

#### **Tr∆∞·ªùng h·ª£p 1: V√© CH∆ØA thanh to√°n**
- X√≥a booking kh·ªèi DB
- Gi·∫£i ph√≥ng gh·∫ø
- **Kh√¥ng c√≥ giao d·ªãch ho√†n ti·ªÅn** (v√¨ ch∆∞a thanh to√°n)
- Kh√¥ng g·ª≠i email

#### **Tr∆∞·ªùng h·ª£p 2: V√© ƒê√É thanh to√°n**
- C·∫≠p nh·∫≠t booking: `status = 'cancelled'`
- T√≠nh ho√†n ti·ªÅn theo t·ª∑ l·ªá
- L∆∞u `refundPercentage` v√† `refundAmount`
- Gi·∫£i ph√≥ng gh·∫ø
- **G·ª≠i email x√°c nh·∫≠n** v·ªõi th√¥ng tin ho√†n ti·ªÅn

---

## 3. C·∫§U TR√öC D·ªÆ LI·ªÜU

### 3.1. Booking Model (`server/models/Booking.js`)

```javascript
{
  user: ObjectId (ref: 'User'),
  show: ObjectId (ref: 'Show'),
  amount: Number,                    // T·ªïng ti·ªÅn ƒë√£ thanh to√°n
  bookedSeats: [String],              // ["A1", "A2", "B5"]
  ispaid: Boolean,                    // ƒê√£ thanh to√°n ch∆∞a
  paymentLink: String,               // Link Stripe checkout
  status: String,                     // "active" | "cancelled"
  cancelledAt: Date,                  // Th·ªùi ƒëi·ªÉm h·ªßy
  refundPercentage: Number,           // % ho√†n ti·ªÅn: 80, 50, 20, 0
  refundAmount: Number                // S·ªë ti·ªÅn ho√†n: amount √ó refundPercentage / 100
}
```

### 3.2. H√†m T√≠nh Ho√†n Ti·ªÅn

**Code:** `server/controllers/bookingController.js` ‚Üí `calculateRefundPercentage()`

```javascript
const calculateRefundPercentage = (showDateTime) => {
    const now = new Date();
    const showTime = new Date(showDateTime);
    const hoursUntilShow = (showTime - now) / (1000 * 60 * 60);

    if (hoursUntilShow >= 24) {
        return 80; // Ho√†n 80% n·∫øu h·ªßy tr∆∞·ªõc 24h
    } else if (hoursUntilShow >= 12) {
        return 50; // Ho√†n 50% n·∫øu h·ªßy tr∆∞·ªõc 12-24h
    } else if (hoursUntilShow >= 6) {
        return 20; // Ho√†n 20% n·∫øu h·ªßy tr∆∞·ªõc 6-12h
    } else {
        return 0; // Kh√¥ng ho√†n n·∫øu h·ªßy d∆∞·ªõi 6h
    }
};
```

**Logic:**
- T√≠nh s·ªë gi·ªù c√≤n l·∫°i = `(showTime - now) / (1000 * 60 * 60)`
- So s√°nh v·ªõi c√°c m·ªëc: 24h, 12h, 6h
- Tr·∫£ v·ªÅ % t∆∞∆°ng ·ª©ng

---

## 4. LU·ªíNG NGHI·ªÜP V·ª§

### 4.1. Lu·ªìng H·ªßy V√© (User)

```
1. User ‚Üí "V√© c·ªßa t√¥i" (MyBookings)
2. T√¨m v√© c·∫ßn h·ªßy
3. Click "H·ªßy v√©" (ch·ªâ hi·ªÉn th·ªã n·∫øu c√≤n ‚â• 6h)
4. X√°c nh·∫≠n h·ªßy
5. Frontend g·ªçi API: POST /api/booking/cancel/:bookingId
6. Backend x·ª≠ l√Ω:
   a. Validate: quy·ªÅn s·ªü h·ªØu, tr·∫°ng th√°i, th·ªùi gian
   b. Gi·∫£i ph√≥ng gh·∫ø
   c. N·∫øu ch∆∞a thanh to√°n ‚Üí X√≥a booking
   d. N·∫øu ƒë√£ thanh to√°n:
      - T√≠nh refundPercentage
      - T√≠nh refundAmount = amount √ó refundPercentage / 100
      - Update booking (status, refundPercentage, refundAmount)
      - Trigger Inngest event "app/booking.cancelled"
7. Inngest g·ª≠i email x√°c nh·∫≠n h·ªßy
8. User nh·∫≠n th√¥ng b√°o + email
```

### 4.2. Lu·ªìng T√≠nh Ho√†n Ti·ªÅn (Backend)

```
1. User click "H·ªßy v√©"
2. Backend nh·∫≠n request: POST /api/booking/cancel/:bookingId
3. Validate:
   - Booking t·ªìn t·∫°i?
   - User c√≥ quy·ªÅn h·ªßy? (booking.user === userId)
   - Booking ch∆∞a b·ªã h·ªßy? (status !== 'cancelled')
   - Show ch∆∞a b·∫Øt ƒë·∫ßu? (showDateTime > now)
4. Gi·∫£i ph√≥ng gh·∫ø:
   - X√≥a c√°c gh·∫ø kh·ªèi Show.occupiedSeats
   - Save Show
5. Ki·ªÉm tra ispaid:
   
   N·∫øu ispaid === false (ch∆∞a thanh to√°n):
   - X√≥a booking kh·ªèi DB
   - Return success (kh√¥ng c√≥ ho√†n ti·ªÅn)
   
   N·∫øu ispaid === true (ƒë√£ thanh to√°n):
   - T√≠nh refundPercentage = calculateRefundPercentage(showDateTime)
   - N·∫øu refundPercentage === 0:
     ‚Üí Ho√†n l·∫°i gh·∫ø (v√¨ kh√¥ng ƒë∆∞·ª£c h·ªßy)
     ‚Üí Return error "Kh√¥ng th·ªÉ h·ªßy d∆∞·ªõi 6h"
   - N·∫øu refundPercentage > 0:
     ‚Üí T√≠nh refundAmount = amount √ó refundPercentage / 100
     ‚Üí Update booking:
        * status = 'cancelled'
        * cancelledAt = new Date()
        * refundPercentage = refundPercentage
        * refundAmount = refundAmount
     ‚Üí Trigger Inngest event "app/booking.cancelled"
     ‚Üí Return success + refund info
6. Inngest function "send-cancellation-email" g·ª≠i email
```

### 4.3. Lu·ªìng G·ª≠i Email H·ªßy V√©

```
1. Backend trigger Inngest event: "app/booking.cancelled"
2. Inngest function "send-cancellation-email" ƒë∆∞·ª£c g·ªçi
3. L·∫•y booking t·ª´ DB (populate show, movie, hall, user)
4. T·∫°o email HTML v·ªõi:
   - Th√¥ng tin v√© ƒë√£ h·ªßy (phim, su·∫•t chi·∫øu, gh·∫ø)
   - Th√¥ng tin ho√†n ti·ªÅn (refundAmount, refundPercentage)
   - Ch√≠nh s√°ch ho√†n v√©
5. G·ª≠i email ƒë·∫øn booking.user.email
6. Subject: "üé´ H·ªßy v√© th√†nh c√¥ng - Ho√†n X% (Y VNƒê)"
```

---

## 5. CODE LI√äN QUAN

### 5.1. Backend

#### **Controller**
- `server/controllers/bookingController.js`:
  - `calculateRefundPercentage(showDateTime)` - T√≠nh % ho√†n ti·ªÅn
  - `cancelBooking(req, res)` - API h·ªßy v√©

#### **Model**
- `server/models/Booking.js` - Schema Booking v·ªõi c√°c tr∆∞·ªùng:
  - `status`: 'active' | 'cancelled'
  - `cancelledAt`: Date
  - `refundPercentage`: Number
  - `refundAmount`: Number

#### **Routes**
- `server/routes/bookingRoutes.js`:
  ```javascript
  bookingRouter.post('/cancel/:bookingId', cancelBooking);
  ```

#### **Inngest Functions**
- `server/inngest/index.js`:
  - `sendCancellationEmail` - G·ª≠i email x√°c nh·∫≠n h·ªßy v√©
  - Trigger: Event `app/booking.cancelled`

### 5.2. Frontend

#### **Pages**
- `client/src/pages/MyBookings.jsx`:
  - Hi·ªÉn th·ªã danh s√°ch bookings
  - N√∫t "H·ªßy v√©" (ch·ªâ hi·ªÉn th·ªã n·∫øu `canCancelBooking()`)
  - Hi·ªÉn th·ªã th√¥ng tin ho√†n ti·ªÅn cho v√© ƒë√£ h·ªßy
  - Function `handleCancelBooking()` - G·ªçi API h·ªßy v√©
  - Function `canCancelBooking()` - Ki·ªÉm tra c√≥ th·ªÉ h·ªßy kh√¥ng

- `client/src/pages/RefundPolicy.jsx`:
  - Trang hi·ªÉn th·ªã ch√≠nh s√°ch ho√†n ti·ªÅn
  - B·∫£ng t·ª∑ l·ªá ho√†n ti·ªÅn theo th·ªùi gian
  - H∆∞·ªõng d·∫´n c√°ch h·ªßy v√©

#### **Components**
- `client/src/components/Footer.jsx` - Link ƒë·∫øn trang RefundPolicy

### 5.3. API Endpoints

| Method | Endpoint | M√¥ t·∫£ | Auth |
|--------|----------|-------|------|
| POST | `/api/booking/cancel/:bookingId` | H·ªßy v√© | User (owner) |

**Request:**
```javascript
POST /api/booking/cancel/:bookingId
Headers: {
  Authorization: "Bearer <token>"
}
Body: {} // Empty
```

**Response (Success):**
```javascript
{
  success: true,
  message: "H·ªßy v√© th√†nh c√¥ng. B·∫°n ƒë∆∞·ª£c ho√†n 80% (200,000 ‚Ç´)",
  refundPercentage: 80,
  refundAmount: 200000
}
```

**Response (Error - Kh√¥ng ƒë∆∞·ª£c h·ªßy):**
```javascript
{
  success: false,
  message: "Kh√¥ng th·ªÉ h·ªßy v√© trong v√≤ng 6 gi·ªù tr∆∞·ªõc su·∫•t chi·∫øu"
}
```

### 5.4. Validation Logic

**Code:** `server/controllers/bookingController.js` ‚Üí `cancelBooking()`

```javascript
// 1. Ki·ªÉm tra booking t·ªìn t·∫°i
if (!booking) {
    return { success: false, message: 'Kh√¥ng t√¨m th·∫•y ƒë·∫∑t v√©' };
}

// 2. Ki·ªÉm tra quy·ªÅn s·ªü h·ªØu
if (booking.user._id.toString() !== userId) {
    return { success: false, message: 'B·∫°n kh√¥ng c√≥ quy·ªÅn h·ªßy v√© n√†y' };
}

// 3. Ki·ªÉm tra tr·∫°ng th√°i
if (booking.status === 'cancelled') {
    return { success: false, message: 'V√© n√†y ƒë√£ ƒë∆∞·ª£c h·ªßy tr∆∞·ªõc ƒë√≥' };
}

// 4. Ki·ªÉm tra th·ªùi gian
if (showTime <= now) {
    return { success: false, message: 'Kh√¥ng th·ªÉ h·ªßy v√© sau khi su·∫•t chi·∫øu ƒë√£ b·∫Øt ƒë·∫ßu' };
}

// 5. T√≠nh % ho√†n ti·ªÅn
const refundPercentage = calculateRefundPercentage(booking.show.showDateTime);

// 6. N·∫øu kh√¥ng ƒë∆∞·ª£c h·ªßy (< 6h)
if (refundPercentage === 0) {
    // Ho√†n l·∫°i gh·∫ø v√¨ kh√¥ng ƒë∆∞·ª£c ph√©p h·ªßy
    // ... restore seats ...
    return { success: false, message: 'Kh√¥ng th·ªÉ h·ªßy v√© trong v√≤ng 6 gi·ªù tr∆∞·ªõc su·∫•t chi·∫øu' };
}
```

---

## 6. C√ÇU H·ªéI TH∆Ø·ªúNG G·∫∂P KHI PH·∫¢N BI·ªÜN

### ‚ùì **C√¢u 1: "Em x·ª≠ l√Ω ch√≠nh s√°ch ho√†n ti·ªÅn nh∆∞ th·∫ø n√†o?"**

**Tr·∫£ l·ªùi:**
> "Em x·ª≠ l√Ω ch√≠nh s√°ch ho√†n ti·ªÅn theo 4 m·ª©c ƒë·ªô d·ª±a tr√™n th·ªùi gian h·ªßy:
> 
> 1. **H·ªßy tr∆∞·ªõc ‚â• 24 gi·ªù**: Ho√†n 80% - Khuy·∫øn kh√≠ch h·ªßy s·ªõm
> 2. **H·ªßy tr∆∞·ªõc 12-24 gi·ªù**: Ho√†n 50% - Ph√≠ h·ªßy 50%
> 3. **H·ªßy tr∆∞·ªõc 6-12 gi·ªù**: Ho√†n 20% - G·∫ßn gi·ªù chi·∫øu, ph√≠ h·ªßy cao
> 4. **H·ªßy d∆∞·ªõi 6 gi·ªù**: Kh√¥ng ƒë∆∞·ª£c h·ªßy - Qu√° g·∫ßn gi·ªù chi·∫øu
> 
> Em c√≥ h√†m `calculateRefundPercentage()` t·ª± ƒë·ªông t√≠nh % d·ª±a tr√™n s·ªë gi·ªù c√≤n l·∫°i tr∆∞·ªõc su·∫•t chi·∫øu. Khi user h·ªßy v√©, h·ªá th·ªëng:
> - T√≠nh refundPercentage
> - T√≠nh refundAmount = amount √ó refundPercentage / 100
> - L∆∞u v√†o booking (refundPercentage, refundAmount)
> - G·ª≠i email x√°c nh·∫≠n v·ªõi th√¥ng tin ho√†n ti·ªÅn
> 
> **X·ª≠ l√Ω 2 tr∆∞·ªùng h·ª£p:**
> - V√© ch∆∞a thanh to√°n: X√≥a booking, kh√¥ng c√≥ ho√†n ti·ªÅn
> - V√© ƒë√£ thanh to√°n: T√≠nh ho√†n ti·ªÅn, g·ª≠i email"

### ‚ùì **C√¢u 2: "T·∫°i sao em kh√¥ng cho h·ªßy d∆∞·ªõi 6 gi·ªù?"**

**Tr·∫£ l·ªùi:**
> "Em kh√¥ng cho h·ªßy d∆∞·ªõi 6 gi·ªù v√¨:
> 
> 1. **L√Ω do nghi·ªáp v·ª•**: Qu√° g·∫ßn gi·ªù chi·∫øu, r·∫°p ƒë√£ chu·∫©n b·ªã xong, vi·ªác h·ªßy s·∫Ω g√¢y l√£ng ph√≠ v√† kh√≥ t√¨m ng∆∞·ªùi thay th·∫ø
> 
> 2. **B·∫£o v·ªá doanh thu**: Tr√°nh t√¨nh tr·∫°ng h·ªßy v√© v√†o ph√∫t cu·ªëi, ·∫£nh h∆∞·ªüng ƒë·∫øn doanh thu c·ªßa r·∫°p
> 
> 3. **C√¥ng b·∫±ng**: User c√≥ ƒë·ªß th·ªùi gian (6 gi·ªù) ƒë·ªÉ quy·∫øt ƒë·ªãnh h·ªßy, n·∫øu ƒë·ªÉ ƒë·∫øn ph√∫t cu·ªëi th√¨ ph·∫£i ch·ªãu tr√°ch nhi·ªám
> 
> 4. **Th·ª±c t·∫ø**: T∆∞∆°ng t·ª± c√°c r·∫°p phim th·ª±c t·∫ø, h·ªç c≈©ng c√≥ quy ƒë·ªãnh kh√¥ng cho h·ªßy/ƒë·ªïi v√© g·∫ßn gi·ªù chi·∫øu
> 
> **Code validation:**
> ```javascript
> if (refundPercentage === 0) {
>     // Ho√†n l·∫°i gh·∫ø v√¨ kh√¥ng ƒë∆∞·ª£c ph√©p h·ªßy
>     return { success: false, message: 'Kh√¥ng th·ªÉ h·ªßy v√© trong v√≤ng 6 gi·ªù tr∆∞·ªõc su·∫•t chi·∫øu' };
> }
> ```"

### ‚ùì **C√¢u 3: "Em t√≠nh ho√†n ti·ªÅn nh∆∞ th·∫ø n√†o?"**

**Tr·∫£ l·ªùi:**
> "Em t√≠nh ho√†n ti·ªÅn theo c√¥ng th·ª©c:
> 
> ```
> refundAmount = (amount √ó refundPercentage) / 100
> ```
> 
> **V√≠ d·ª•:**
> - V√© gi√°: 250,000 VNƒê
> - H·ªßy tr∆∞·ªõc 24h ‚Üí refundPercentage = 80%
> - refundAmount = (250,000 √ó 80) / 100 = 200,000 VNƒê
> 
> **Code:**
> ```javascript
> const refundPercentage = calculateRefundPercentage(booking.show.showDateTime);
> const refundAmount = Math.floor((booking.amount * refundPercentage) / 100);
> ```
> 
> H√†m `calculateRefundPercentage()` t√≠nh s·ªë gi·ªù c√≤n l·∫°i v√† so s√°nh v·ªõi c√°c m·ªëc 24h, 12h, 6h ƒë·ªÉ tr·∫£ v·ªÅ % t∆∞∆°ng ·ª©ng."

### ‚ùì **C√¢u 4: "Em x·ª≠ l√Ω v√© ch∆∞a thanh to√°n nh∆∞ th·∫ø n√†o?"**

**Tr·∫£ l·ªùi:**
> "V·ªõi v√© ch∆∞a thanh to√°n (ispaid = false), em x·ª≠ l√Ω ƒë∆°n gi·∫£n h∆°n:
> 
> 1. **X√≥a booking**: Kh√¥ng c·∫ßn t√≠nh ho√†n ti·ªÅn v√¨ ch∆∞a c√≥ giao d·ªãch thanh to√°n
> 2. **Gi·∫£i ph√≥ng gh·∫ø**: X√≥a c√°c gh·∫ø kh·ªèi Show.occupiedSeats
> 3. **Kh√¥ng g·ª≠i email**: V√¨ kh√¥ng c√≥ giao d·ªãch ho√†n ti·ªÅn
> 
> **Code:**
> ```javascript
> if (!booking.ispaid) {
>     await Booking.findByIdAndDelete(booking._id);
>     return res.json({ 
>         success: true, 
>         message: 'H·ªßy v√© th√†nh c√¥ng'
>     });
> }
> ```
> 
> ƒêi·ªÅu n√†y h·ª£p l√Ω v√¨ user ch∆∞a tr·∫£ ti·ªÅn n√™n kh√¥ng c·∫ßn ho√†n ti·ªÅn."

### ‚ùì **C√¢u 5: "Em g·ª≠i email x√°c nh·∫≠n h·ªßy nh∆∞ th·∫ø n√†o?"**

**Tr·∫£ l·ªùi:**
> "Em s·ª≠ d·ª•ng Inngest ƒë·ªÉ g·ª≠i email t·ª± ƒë·ªông:
> 
> 1. **Trigger**: Sau khi h·ªßy v√© th√†nh c√¥ng, backend trigger Inngest event `app/booking.cancelled`
> 
> 2. **Inngest Function**: Function `send-cancellation-email` ƒë∆∞·ª£c g·ªçi t·ª± ƒë·ªông
> 
> 3. **N·ªôi dung email**:
>    - Th√¥ng tin v√© ƒë√£ h·ªßy (phim, su·∫•t chi·∫øu, gh·∫ø, s·ªë ti·ªÅn ƒë√£ thanh to√°n)
>    - Th√¥ng tin ho√†n ti·ªÅn (refundAmount, refundPercentage)
>    - Ch√≠nh s√°ch ho√†n v√©
>    - Link xem phim kh√°c
> 
> 4. **Subject**: "üé´ H·ªßy v√© th√†nh c√¥ng - Ho√†n X% (Y VNƒê)"
> 
> **Code:** `server/inngest/index.js` ‚Üí `sendCancellationEmail()`
> 
> Email ƒë∆∞·ª£c g·ª≠i t·ª± ƒë·ªông, kh√¥ng c·∫ßn user l√†m g√¨ th√™m."

### ‚ùì **C√¢u 6: "Em validate h·ªßy v√© nh∆∞ th·∫ø n√†o?"**

**Tr·∫£ l·ªùi:**
> "Em c√≥ nhi·ªÅu l·ªõp validation:
> 
> **1. Ki·ªÉm tra quy·ªÅn s·ªü h·ªØu:**
>    - Ch·ªâ owner c·ªßa booking m·ªõi ƒë∆∞·ª£c h·ªßy
>    ```javascript
>    if (booking.user._id.toString() !== userId) {
>        return { success: false, message: 'B·∫°n kh√¥ng c√≥ quy·ªÅn h·ªßy v√© n√†y' };
>    }
>    ```
> 
> **2. Ki·ªÉm tra tr·∫°ng th√°i:**
>    - Kh√¥ng cho h·ªßy v√© ƒë√£ b·ªã h·ªßy
>    ```javascript
>    if (booking.status === 'cancelled') {
>        return { success: false, message: 'V√© n√†y ƒë√£ ƒë∆∞·ª£c h·ªßy tr∆∞·ªõc ƒë√≥' };
>    }
>    ```
> 
> **3. Ki·ªÉm tra th·ªùi gian:**
>    - Kh√¥ng cho h·ªßy sau khi show ƒë√£ b·∫Øt ƒë·∫ßu
>    ```javascript
>    if (showTime <= now) {
>        return { success: false, message: 'Kh√¥ng th·ªÉ h·ªßy v√© sau khi su·∫•t chi·∫øu ƒë√£ b·∫Øt ƒë·∫ßu' };
>    }
>    ```
> 
> **4. Ki·ªÉm tra th·ªùi gian h·ªßy:**
>    - T√≠nh refundPercentage, n·∫øu = 0 ‚Üí kh√¥ng ƒë∆∞·ª£c h·ªßy (< 6h)
>    ```javascript
>    if (refundPercentage === 0) {
>        // Ho√†n l·∫°i gh·∫ø
>        return { success: false, message: 'Kh√¥ng th·ªÉ h·ªßy v√© trong v√≤ng 6 gi·ªù tr∆∞·ªõc su·∫•t chi·∫øu' };
>    }
>    ```
> 
> **5. Frontend validation:**
>    - Ch·ªâ hi·ªÉn th·ªã n√∫t "H·ªßy v√©" n·∫øu `canCancelBooking()` = true
>    - Function n√†y ki·ªÉm tra: status !== 'cancelled' && hoursUntilShow >= 6"

### ‚ùì **C√¢u 7: "Em gi·∫£i ph√≥ng gh·∫ø khi h·ªßy nh∆∞ th·∫ø n√†o?"**

**Tr·∫£ l·ªùi:**
> "Khi h·ªßy v√©, em gi·∫£i ph√≥ng gh·∫ø ngay l·∫≠p t·ª©c:
> 
> **Code:**
> ```javascript
> const showData = await Show.findById(booking.show._id);
> booking.bookedSeats.forEach(seat => {
>     delete showData.occupiedSeats[seat];
> });
> showData.markModified('occupiedSeats');
> await showData.save();
> ```
> 
> **Quy tr√¨nh:**
> 1. L·∫•y Show t·ª´ DB
> 2. Duy·ªát qua t·∫•t c·∫£ gh·∫ø ƒë√£ ƒë·∫∑t (`bookedSeats`)
> 3. X√≥a t·ª´ng gh·∫ø kh·ªèi `Show.occupiedSeats` object
> 4. D√πng `markModified()` ƒë·ªÉ b√°o cho Mongoose bi·∫øt object ƒë√£ thay ƒë·ªïi
> 5. Save Show
> 
> **L∆∞u √Ω**: N·∫øu kh√¥ng ƒë∆∞·ª£c h·ªßy (< 6h), em s·∫Ω ho√†n l·∫°i gh·∫ø (restore) ƒë·ªÉ ƒë·∫£m b·∫£o gh·∫ø v·∫´n b·ªã chi·∫øm gi·ªØ."

---

## üìù T√ìM T·∫ÆT ƒêI·ªÇM M·∫†NH

‚úÖ **Ch√≠nh s√°ch r√µ r√†ng**: 4 m·ª©c ƒë·ªô ho√†n ti·ªÅn theo th·ªùi gian  
‚úÖ **T√≠nh to√°n t·ª± ƒë·ªông**: H√†m `calculateRefundPercentage()` t·ª± ƒë·ªông t√≠nh %  
‚úÖ **Validation ch·∫∑t ch·∫Ω**: Nhi·ªÅu l·ªõp ki·ªÉm tra (quy·ªÅn, tr·∫°ng th√°i, th·ªùi gian)  
‚úÖ **X·ª≠ l√Ω 2 tr∆∞·ªùng h·ª£p**: V√© ch∆∞a thanh to√°n vs ƒë√£ thanh to√°n  
‚úÖ **Email t·ª± ƒë·ªông**: G·ª≠i email x√°c nh·∫≠n v·ªõi th√¥ng tin chi ti·∫øt  
‚úÖ **Gi·∫£i ph√≥ng gh·∫ø**: T·ª± ƒë·ªông gi·∫£i ph√≥ng gh·∫ø khi h·ªßy  
‚úÖ **UX t·ªët**: Ch·ªâ hi·ªÉn th·ªã n√∫t h·ªßy khi c√≥ th·ªÉ h·ªßy, hi·ªÉn th·ªã th√¥ng tin ho√†n ti·ªÅn  

---

## üéØ L∆ØU √ù KHI PH·∫¢N BI·ªÜN

1. **Nh·∫•n m·∫°nh t√≠nh c√¥ng b·∫±ng**: Ch√≠nh s√°ch b·∫£o v·ªá c·∫£ user v√† r·∫°p
2. **Gi·∫£i th√≠ch l√Ω do**: T·∫°i sao kh√¥ng cho h·ªßy d∆∞·ªõi 6h
3. **Demo n·∫øu c√≥ th·ªÉ**: Show c√°ch h·ªßy v√© v√† nh·∫≠n email
4. **N√≥i v·ªÅ t√≠ch h·ª£p**: Inngest t·ª± ƒë·ªông g·ª≠i email, kh√¥ng c·∫ßn can thi·ªáp th·ªß c√¥ng
5. **Validation**: Nh·∫•n m·∫°nh nhi·ªÅu l·ªõp ki·ªÉm tra ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n

---

## üìÇ DANH S√ÅCH FILE CODE

### Backend:
- `server/models/Booking.js` - Model v·ªõi c√°c tr∆∞·ªùng refund
- `server/controllers/bookingController.js` - Logic h·ªßy v√© v√† t√≠nh ho√†n ti·ªÅn
- `server/routes/bookingRoutes.js` - Route API h·ªßy v√©
- `server/inngest/index.js` - Function g·ª≠i email h·ªßy v√©

### Frontend:
- `client/src/pages/MyBookings.jsx` - Trang qu·∫£n l√Ω v√©, n√∫t h·ªßy v√©
- `client/src/pages/RefundPolicy.jsx` - Trang ch√≠nh s√°ch ho√†n ti·ªÅn
- `client/src/components/Footer.jsx` - Link ƒë·∫øn RefundPolicy

---

**Ch√∫c b·∫°n ph·∫£n bi·ªán th√†nh c√¥ng! üéâ**

